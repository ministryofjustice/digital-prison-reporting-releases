version: 2.1

orbs:
  reporting: ministryofjustice/hmpps-reporting@1.0.68

parameters:
  project:
    type: string
    default: ""
  release_tag:
    type: string
    default: ""
  is_pr:
    type: boolean
    default: false
  executor:
    type: string
    default: 'reporting/java'
  tag:
    type: string
    default: "11.0"
  resource_class:
    type: string
    default: "large"    
  is_release:
    type: boolean
    default: false  
  skip:
    description: if set to true will skip the workflow
    type: boolean
    default: false
  sync_artifacts:
    description: Sync Artifacts to S3, Only Valid for Service Bundle
    type: boolean
    default: false    
  project_key:
    type: string
    default: ""

jobs:
  build_type:
    docker:
      - image: cimg/base:stable
    steps:
      - run: 
          name: Build Type
          command: |
            echo "INFO: Project Key, << pipeline.parameters.project_key >>"          
            echo "INFO: Downstream Executor, << pipeline.parameters.executor >>"
            echo "INFO: Downstream Image TAG, << pipeline.parameters.tag >>"
            echo "INFO: Project Key: << pipeline.parameters.project_key >>"          
            echo "INFO: Executor: << pipeline.parameters.executor >>"
            echo "INFO: Executor Tag: << pipeline.parameters.tag >>"

  update_release_history:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout

      - run:
          name: Install yq
          command: |
            sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 \
              -O /usr/local/bin/yq && sudo chmod +x /usr/local/bin/yq

      - run:
          name: Update README release history (no push)
          command: .github/scripts/update-release-history.sh

workflows:
  release:
    when:
      not: << pipeline.parameters.skip >>
    jobs:
      - build_type
      - reporting/generic_release:
          sync_args: "--exclude '*' --include '*-all*jar'"
          release_ready: true
          build_args: "-x test"
          dry_run: false
          notify_slack: false
          skip_flyway_validate: true
          aws_sync_artifacts: << pipeline.parameters.sync_artifacts >>
          project_key: << pipeline.parameters.project_key >>
          executor: 
            name: << pipeline.parameters.executor >>
            tag: << pipeline.parameters.tag >>
            class: << pipeline.parameters.resource_class >>
          is_pr: << pipeline.parameters.is_pr >>
          is_release: << pipeline.parameters.is_release >>
          ref: << pipeline.git.branch >><< pipeline.git.tag >>
          is_rollback: false
          context:
            - hmpps-reporting-common
          filters:
            branches:
              only: /.*/
            tags:
              ignore: /.*/
          requires: [build_type]

  update-readme-history:
    jobs:
      - update_release_history:
          filters:
            branches:
              only: /.*/
            paths:
              - "prod/*"
              - "preprod/*"
              - ".github/scripts/*"
              - "README.md"